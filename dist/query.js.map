{"version":3,"sources":["../src/query.js"],"names":["Query","attrs","_ast","ast","_form","form","_outputs","_schema","schema","_filter","filter","_sorting","sort","_boundingBox","bounding_box","_searchFilter","_dateFilter","date_filter","field","_statusFilter","status_filter","_projectFilter","project_filter","_assignmentFilter","assignment_filter","_options","options","_columnSettings","columns","setup","clearAllFilters","statusFilter","reset","projectFilter","assignmentFilter","columnSettings","toJSON","boundingBox","outputs","map","o","sorting","search_filter","searchFilter","dateFilter","column_settings","toRawAST","toAST","toCountAST","toTileAST","toDistinctValuesAST","toHistogramAST","applySort","pageSize","pageIndex","outerLimit","finalLimit","sortClause","outerSortClause","fromClause","runtimeFilters","targetList","limitCount","toSchemaSQL","wrapped","toSchemaAST","deparse","toDistinctValuesSQL","toHistogramSQL","toCountSQL","toSQL","toTileSQL","timeZoneCast","columnRef","timeZoneFormat","joinedColumns","subJoinColumns","joinColumnsWithSorting","indexOf","createdByColumn","push","updatedByColumn","assignedToColumn","projectColumn","id","baseQuery","leftJoinClause","toHumanDescription","parts","description","desc","join","geometryColumns","length","geometryResTarget","SelectStmt","index","geometryResTargetCopy","JSON","parse","stringify","ResTarget","name","hasFilter","find","isValid","expressions","hasSort","joins","column","apply","allExpressions","joinColumns","box","isEmpty","systemSortClause","sorts","direction","columnName","source","flatten"],"mappings":"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","file":"query.js","sourcesContent":["import { Condition } from './condition';\nimport { Expression } from './expression';\nimport SortExpressions from './sort-expressions';\nimport Converter from './ast/converter';\nimport ColumnFilter from './column-filter';\nimport Deparse from 'pg-query-deparser';\nimport QueryOptions from './query-options';\nimport _ from 'lodash';\nimport ColumnSettings from './column-settings';\n\nimport { ResTarget,\n         ColumnRef,\n         FuncCall,\n         AConst,\n         StringValue,\n         TypeCast,\n         TypeName,\n         Alias,\n         RangeSubselect,\n         SelectStmt,\n         SortBy,\n         IntegerValue,\n         AStar } from './ast/helpers';\n\nexport default class Query {\n  constructor(attrs) {\n    this._ast = attrs.ast;\n    this._form = attrs.form;\n    this._outputs = [];\n    this._schema = attrs.schema;\n    this._filter = new Condition(attrs.filter, attrs.schema);\n    this._sorting = new SortExpressions(attrs.sort, attrs.schema);\n    this._boundingBox = attrs.bounding_box || null;\n    this._searchFilter = '';\n    this._dateFilter = new Expression(attrs.date_filter || {field: '_server_updated_at'}, attrs.schema);\n    this._statusFilter = new ColumnFilter({...attrs.status_filter, field: '_status'}, this._schema);\n    this._projectFilter = new ColumnFilter({...attrs.project_filter, field: 'project.name'}, this._schema);\n    this._assignmentFilter = new ColumnFilter({...attrs.assignment_filter, field: 'assigned_to.name'}, this._schema);\n    this._options = new QueryOptions(attrs.options || {});\n    this._columnSettings = new ColumnSettings(this._schema, attrs.columns);\n\n    this.setup();\n  }\n\n  get ast() {\n    return this._ast;\n  }\n\n  get form() {\n    return this._form;\n  }\n\n  get schema() {\n    return this._schema;\n  }\n\n  get outputs() {\n    return this._outputs;\n  }\n\n  get filter() {\n    return this._filter;\n  }\n\n  get sorting() {\n    return this._sorting;\n  }\n\n  get columnSettings() {\n    return this._columnSettings;\n  }\n\n  get dateFilter() {\n    return this._dateFilter;\n  }\n\n  get statusFilter() {\n    return this._statusFilter;\n  }\n\n  get projectFilter() {\n    return this._projectFilter;\n  }\n\n  get assignmentFilter() {\n    return this._assignmentFilter;\n  }\n\n  get options() {\n    return this._options;\n  }\n\n  get hasFilter() {\n    return this.statusFilter.hasFilter ||\n           this.projectFilter.hasFilter ||\n           this.assignmentFilter.hasFilter ||\n           this.columnSettings.columns.find(o => o.hasFilter) ||\n           this.searchFilter ||\n           this.dateFilter.isValid ||\n           this.filter.expressions.find(o => o.isValid) ||\n           this.sorting.hasSort;\n  }\n\n  get joinColumns() {\n    const joins = [];\n\n    if (this.projectFilter.hasFilter) {\n      joins.push(this.projectFilter.column);\n    }\n\n    if (this.assignmentFilter.hasFilter) {\n      joins.push(this.assignmentFilter.column);\n    }\n\n    joins.push.apply(joins, this.columnSettings.columns.filter((o) => {\n      return o.hasFilter && o.column.join;\n    }).map(o => o.column));\n\n    joins.push.apply(joins, this.filter.allExpressions.filter((o) => {\n      return o.isValid && o.column.join;\n    }).map(o => o.column));\n\n    return joins;\n  }\n\n  get joinColumnsWithSorting() {\n    const joins = this.joinColumns;\n\n    if (this.sorting.hasSort) {\n      joins.push.apply(joins, this.sorting.expressions.filter((o) => {\n        return o.isValid && o.column.join;\n      }).map(o => o.column));\n    }\n\n    return joins;\n  }\n\n  clearAllFilters() {\n    this.statusFilter.reset();\n    this.projectFilter.reset();\n    this.assignmentFilter.reset();\n\n    this.columnSettings.reset();\n\n    this._filter = new Condition(null, this._schema);\n    this._sorting = new SortExpressions(null, this._schema);\n    // this._boundingBox = null;\n    this._searchFilter = '';\n    this._dateFilter = new Expression({field: '_server_updated_at'}, this._schema);\n  }\n\n  set boundingBox(box) {\n    this._boundingBox = box;\n  }\n\n  get boundingBox() {\n    return this._boundingBox;\n  }\n\n  get searchFilter() {\n    return this._searchFilter || '';\n  }\n\n  set searchFilter(filter) {\n    this._searchFilter = filter;\n  }\n\n  get runtimeFilters() {\n    return {\n      boundingBox: this.boundingBox,\n      searchFilter: this.searchFilter,\n      dateFilter: this.dateFilter\n    };\n  }\n\n  toJSON({boundingBox = false} = {}) {\n    return {\n      outputs: this.outputs.map(o => o.toJSON()),\n      filter: this.filter.toJSON(),\n      sorting: this.sorting.toJSON(),\n      options: this.options.toJSON(),\n      bounding_box: boundingBox ? this.boundingBox : null,\n      search_filter: this.searchFilter,\n      date_filter: this.dateFilter.toJSON(),\n      columns: this.columnSettings.toJSON(),\n      status_filter: this.statusFilter.toJSON(),\n      project_filter: this.projectFilter.toJSON(),\n      assignment_filter: this.assignmentFilter.toJSON(),\n      column_settings: this.columnSettings.toJSON()\n    };\n  }\n\n  toRawAST(options) {\n    return new Converter().toAST(this, options);\n  }\n\n  toCountAST(options) {\n    return new Converter().toCountAST(this, options);\n  }\n\n  toTileAST(options) {\n    return new Converter().toTileAST(this, options);\n  }\n\n  toDistinctValuesAST(options) {\n    return new Converter().toDistinctValuesAST(this, options);\n  }\n\n  toHistogramAST(options) {\n    return new Converter().toHistogramAST(this, options);\n  }\n\n  toAST({applySort, pageSize, pageIndex, outerLimit}) {\n    const finalLimit = outerLimit ? AConst(IntegerValue(+outerLimit)) : null;\n\n    const sortClause = applySort ? this.outerSortClause : null;\n\n    const fromClause = this.fromClause({applySort, pageSize, pageIndex, ...this.runtimeFilters});\n\n    return SelectStmt({\n      targetList: this.targetList(),\n      fromClause: fromClause,\n      sortClause: sortClause,\n      limitCount: finalLimit\n    });\n  }\n\n  toSchemaSQL(ast, options) {\n    const wrapped = new Converter().toSchemaAST(ast, options);\n    return new Deparse().deparse(wrapped);\n  }\n\n  toDistinctValuesSQL(options) {\n    return new Deparse().deparse(this.toDistinctValuesAST(options));\n  }\n\n  toHistogramSQL(options) {\n    return new Deparse().deparse(this.toHistogramAST(options));\n  }\n\n  toCountSQL() {\n    return new Deparse().deparse(this.toCountAST(this.runtimeFilters));\n  }\n\n  toSQL({applySort, pageSize, pageIndex, outerLimit}) {\n    const options = {\n      applySort,\n      pageSize,\n      pageIndex,\n      outerLimit,\n      ...this.runtimeFilters\n    };\n\n    return new Deparse().deparse(this.toAST(options));\n  }\n\n  toTileSQL() {\n    return new Deparse().deparse(this.toTileAST(this.runtimeFilters));\n  }\n\n  targetList() {\n    if (this.ast) {\n      return [ ResTarget(ColumnRef(AStar())) ];\n    }\n\n    const timeZoneCast = (columnRef) => {\n      return FuncCall([ StringValue('pg_catalog'), StringValue('timezone') ], [ AConst(StringValue('UTC')), columnRef ]);\n    };\n\n    const timeZoneFormat = AConst(StringValue('YYYY-MM-DD\"T\"HH24:MI:SS\"Z\"'));\n\n    const joinedColumns = [];\n\n    // The \"subJoinColumns\" are joins that need to happen in the inner sub-select from Converter.\n    // We don't need to join them in the outer part.\n    const subJoinColumns = this.joinColumnsWithSorting;\n\n    if (subJoinColumns.indexOf(this.schema.createdByColumn) === -1) {\n      joinedColumns.push(ResTarget(ColumnRef('name', 'created_by'), 'created_by'));\n    } else {\n      joinedColumns.push(ResTarget(ColumnRef('created_by.name'), 'created_by'));\n    }\n\n    if (subJoinColumns.indexOf(this.schema.updatedByColumn) === -1) {\n      joinedColumns.push(ResTarget(ColumnRef('name', 'updated_by'), 'updated_by'));\n    } else {\n      joinedColumns.push(ResTarget(ColumnRef('updated_by.name'), 'updated_by'));\n    }\n\n    if (subJoinColumns.indexOf(this.schema.assignedToColumn) === -1) {\n      joinedColumns.push(ResTarget(ColumnRef('name', 'assigned_to'), 'assigned_to'));\n    } else {\n      joinedColumns.push(ResTarget(ColumnRef('assigned_to.name'), 'assigned_to'));\n    }\n\n    if (subJoinColumns.indexOf(this.schema.projectColumn) === -1) {\n      joinedColumns.push(ResTarget(ColumnRef('name', 'project'), 'project'));\n    } else {\n      joinedColumns.push(ResTarget(ColumnRef('project.name'), 'project'));\n    }\n\n    return [\n      ResTarget(ColumnRef('_status'), 'status'),\n      ResTarget(ColumnRef('_version'), 'version'),\n      ResTarget(ColumnRef('_record_id'), 'id'),\n      ResTarget(FuncCall('to_char', [ timeZoneCast(ColumnRef('_server_created_at')),\n                                      timeZoneFormat ]), 'created_at'),\n      ResTarget(FuncCall('to_char', [ timeZoneCast(ColumnRef('_server_updated_at')),\n                                      timeZoneFormat ]), 'updated_at'),\n      ResTarget(FuncCall('to_char', [ timeZoneCast(ColumnRef('_created_at')),\n                                      timeZoneFormat ]), 'client_created_at'),\n      ResTarget(FuncCall('to_char', [ timeZoneCast(ColumnRef('_updated_at')),\n                                      timeZoneFormat ]), 'client_updated_at'),\n      ResTarget(ColumnRef('_created_by_id'), 'created_by_id'),\n      ResTarget(ColumnRef('_updated_by_id'), 'updated_by_id'),\n      ResTarget(TypeCast(TypeName('text'), AConst(StringValue(this.form.id))), 'form_id'),\n      ResTarget(ColumnRef('_project_id'), 'project_id'),\n      ResTarget(ColumnRef('_assigned_to_id'), 'assigned_to_id'),\n      ResTarget(ColumnRef('_form_values'), 'form_values'),\n      ResTarget(ColumnRef('_latitude'), 'latitude'),\n      ResTarget(ColumnRef('_longitude'), 'longitude'),\n      ResTarget(ColumnRef('_altitude'), 'altitude'),\n      ResTarget(ColumnRef('_speed'), 'speed'),\n      ResTarget(ColumnRef('_course'), 'course'),\n      ResTarget(ColumnRef('_horizontal_accuracy'), 'horizontal_accuracy'),\n      ResTarget(ColumnRef('_vertical_accuracy'), 'vertical_accuracy'),\n      ResTarget(ColumnRef('_edited_duration'), 'edited_duration'),\n      ResTarget(ColumnRef('_updated_duration'), 'updated_duration'),\n      ResTarget(ColumnRef('_created_duration'), 'created_duration'),\n      ...joinedColumns\n    ];\n  }\n\n  fromClause({applySort, pageSize, pageIndex, boundingBox, searchFilter}) {\n    const ast = applySort ? this.toRawAST({sort: this.sortClause, pageSize, pageIndex, boundingBox, searchFilter})\n                          : this.toRawAST({boundingBox, searchFilter});\n\n    let baseQuery = RangeSubselect(ast, Alias('records'));\n\n    if (this.ast) {\n      return [ baseQuery ];\n    }\n\n    // The \"subJoinColumns\" are joins that need to happen in the inner sub-select from Converter.\n    // We don't need to join them in the outer part.\n    const subJoinColumns = this.joinColumnsWithSorting;\n\n    if (subJoinColumns.indexOf(this.schema.createdByColumn) === -1) {\n      baseQuery = Converter.leftJoinClause(baseQuery, 'memberships', 'created_by', '_created_by_id', 'user_id');\n    }\n\n    if (subJoinColumns.indexOf(this.schema.updatedByColumn) === -1) {\n      baseQuery = Converter.leftJoinClause(baseQuery, 'memberships', 'updated_by', '_updated_by_id', 'user_id');\n    }\n\n    if (subJoinColumns.indexOf(this.schema.assignedToColumn) === -1) {\n      baseQuery = Converter.leftJoinClause(baseQuery, 'memberships', 'assigned_to', '_assigned_to_id', 'user_id');\n    }\n\n    if (subJoinColumns.indexOf(this.schema.projectColumn) === -1) {\n      baseQuery = Converter.leftJoinClause(baseQuery, 'projects', 'project', '_project_id', 'project_id');\n    }\n\n    return [ baseQuery ];\n  }\n\n  get sortClause() {\n    if (this.sorting.isEmpty) {\n      return this.systemSortClause;\n    }\n\n    // always add the record ID to the sorting so it's stable across executions\n    const sorts = this.sorting.expressions.map((sort) => {\n      const direction = sort.direction === 'desc' ? 2 : 1;\n\n      if (this.ast) {\n        return [\n          SortBy(ColumnRef(sort.column.columnName, sort.column.source), direction, 0)\n        ];\n      }\n\n      return [\n        SortBy(ColumnRef(sort.column.columnName, sort.column.source), direction, 0),\n        SortBy(ColumnRef('_record_id'), direction, 0)\n      ];\n    });\n\n    return _.flatten(sorts);\n  }\n\n  get systemSortClause() {\n    if (this.ast) {\n      return [ SortBy(AConst(IntegerValue(1)), 2, 0) ];\n    }\n\n    return [ SortBy(ColumnRef('_server_updated_at'), 2, 0) ];\n  }\n\n  get outerSortClause() {\n    return [ SortBy(ColumnRef('_row_number'), 1, 0) ];\n  }\n\n  toHumanDescription() {\n    const parts = [];\n\n    let description = null;\n\n    if ((description = this.statusFilter.toHumanDescription())) {\n      parts.push(description);\n    }\n\n    if ((description = this.projectFilter.toHumanDescription())) {\n      parts.push(description);\n    }\n\n    if ((description = this.assignmentFilter.toHumanDescription())) {\n      parts.push(description);\n    }\n\n    if ((description = this.columnSettings.columns.map(o => o.filter).map(o => o.toHumanDescription()))) {\n      for (const desc of description) {\n        if (desc) {\n          parts.push(desc);\n        }\n      }\n    }\n\n    if (this.searchFilter) {\n      parts.push('Search by ' + this.searchFilter);\n    }\n\n    if ((description = this.dateFilter.toHumanDescription())) {\n      parts.push(description);\n    }\n\n    if ((description = this.filter.toHumanDescription())) {\n      parts.push(description);\n    }\n\n    if ((description = this.sorting.toHumanDescription())) {\n      parts.push(description);\n    }\n\n    return parts.join(', ');\n  }\n\n  setup() {\n    const geometryColumns = this.schema.geometryColumns;\n\n    if (geometryColumns.length) {\n      // For custom SQL, we need to add a column called __geometry at the end that evaluates to the\n      // exact same expression as the first geometry column. This is needed so that queries like\n      // SELECT geom, * FROM table will work when we need to reference the geom column from an outer\n      // query.\n      const geometryResTarget = this.ast.SelectStmt.targetList[geometryColumns[0].index];\n\n      const geometryResTargetCopy = JSON.parse(JSON.stringify(geometryResTarget));\n\n      geometryResTargetCopy.ResTarget.name = '__geometry';\n\n      this.ast.SelectStmt.targetList.push(geometryResTargetCopy);\n    }\n  }\n}\n"]}