{"version":3,"sources":["../src/repeatable-schema.js"],"names":["SYSTEM_COLUMNS","RepeatableSchema","formSchema","repeatable","rawColumns","fullSchema","container","_columns","_rawColumns","_rawColumnsByKey","_columnsByKey","column","indexOf","name","field","key","part","setupColumns","addSystemColumn","feature","options","recordID","record","id","parentID","console","log","parent","form","statusField","isEnabled","addRawElementColumn","_record_status","isProjectEnabled","projectColumn","tableName","alias","sourceColumn","joinColumn","isAssignmentEnabled","assignedToColumn","createdByColumn","updatedByColumn","setupElementColumns","dataName"],"mappings":"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","file":"repeatable-schema.js","sourcesContent":["import FormFieldSchema from './form-field-schema';\n\nconst SYSTEM_COLUMNS = [\n  '_child_record_id',\n  '_record_id',\n  '_parent_id',\n  '_record_project_id',\n  '_record_assigned_to_id',\n  '_record_status',\n  '_index',\n  '_latitude',\n  '_longitude',\n  '_created_at',\n  '_updated_at',\n  '_version',\n  '_created_by_id',\n  '_updated_by_id',\n  '_server_created_at',\n  '_server_updated_at',\n  '_geometry',\n  '_changeset_id',\n  '_title',\n  '_created_latitude',\n  '_created_longitude',\n  '_created_geometry',\n  '_created_altitude',\n  '_created_horizontal_accuracy',\n  '_updated_latitude',\n  '_updated_longitude',\n  '_updated_geometry',\n  '_updated_altitude',\n  '_updated_horizontal_accuracy',\n  '_created_duration',\n  '_updated_duration',\n  '_edited_duration'\n];\n\nexport default class RepeatableSchema extends FormFieldSchema {\n  constructor(formSchema, repeatable, rawColumns, {fullSchema = false}) {\n    super({fullSchema});\n\n    this.formSchema = formSchema;\n    this.repeatable = repeatable;\n    this.container = repeatable;\n\n    this._columns = [];\n    this._rawColumns = rawColumns;\n\n    this._rawColumnsByKey = {};\n    this._columnsByKey = {};\n\n    for (const column of rawColumns) {\n      if (SYSTEM_COLUMNS.indexOf(column.name) !== -1) {\n        this._rawColumnsByKey[column.name] = column;\n      } else if (column.field) {\n        const key = column.part ? column.field + '_' + column.part : column.field;\n        this._rawColumnsByKey[key] = column;\n      }\n    }\n\n    this.setupColumns();\n  }\n\n  setupColumns() {\n    if (this.fullSchema) {\n      this.addSystemColumn('Child Record ID', 'id', '_child_record_id', 'string');\n\n      this.addSystemColumn('Record ID', null, '_record_id', 'string', (feature, options) => {\n        if (feature.recordID) {\n          return feature.recordID;\n        }\n\n        return options && options.record.id;\n      });\n\n      this.addSystemColumn('Parent ID', null, '_parent_id', 'string', (feature, options) => {\n        if (feature.parentID) {\n          return feature.parentID;\n        }\n\n        console.log('PARENT', feature);\n        return options && options.parent.id;\n      });\n    }\n\n    if (this.formSchema.form.statusField.isEnabled) {\n      this.addRawElementColumn(this.formSchema.form.statusField,\n                               this._rawColumnsByKey._record_status,\n                               '_record_status',\n                               'string',\n                               null,\n                               '_record_status');\n    }\n\n    this.addSystemColumn('Version', 'version', '_version', 'integer');\n    this.addSystemColumn('Device Created', 'createdAt', '_created_at', 'timestamp');\n    this.addSystemColumn('Device Updated', 'updatedAt', '_updated_at', 'timestamp');\n\n    if (this.formSchema.form.isProjectEnabled) {\n      this.projectColumn = this.addSystemColumn('Project',\n                                                'recordProjectName',\n                                                'project.name',\n                                                'string',\n                                                null,\n                                                {tableName: 'projects',\n                                                 alias: 'project',\n                                                 sourceColumn: '_record_project_id',\n                                                 joinColumn: 'project_id'});\n    }\n\n    if (this.formSchema.form.isAssignmentEnabled) {\n      this.assignedToColumn = this.addSystemColumn('Assigned',\n                                                   'recordAssignedToName',\n                                                   'assigned_to.name',\n                                                   'string',\n                                                   null,\n                                                   {tableName: 'memberships',\n                                                    alias: 'assigned_to',\n                                                    sourceColumn: '_record_assigned_to_id',\n                                                    joinColumn: 'user_id'});\n    }\n\n    this.createdByColumn = this.addSystemColumn('Created By',\n                                                'createdByName',\n                                                'created_by.name',\n                                                'string',\n                                                null,\n                                                {tableName: 'memberships',\n                                                 alias: 'created_by',\n                                                 sourceColumn: '_created_by_id',\n                                                 joinColumn: 'user_id'});\n\n    this.updatedByColumn = this.addSystemColumn('Updated By',\n                                                'updatedByName',\n                                                'updated_by.name',\n                                                'string',\n                                                null,\n                                                {tableName: 'memberships',\n                                                 alias: 'updated_by',\n                                                 sourceColumn: '_updated_by_id',\n                                                 joinColumn: 'user_id'});\n\n    if (this.fullSchema) {\n      this.addSystemColumn('Item Index', 'index', '_index', 'integer');\n      this.addSystemColumn('Geometry', 'geometryAsGeoJSON', '_geometry', 'geometry');\n      this.addSystemColumn('Latitude', 'latitude', '_latitude', 'double');\n      this.addSystemColumn('Longitude', 'longitude', '_longitude', 'double');\n\n      this.addSystemColumn('Altitude', 'altitude', '_altitude', 'double');\n      this.addSystemColumn('Accuracy', 'horizontalAccuracy', '_horizontal_accuracy', 'double');\n      this.addSystemColumn('Changeset', 'changesetID', '_changeset_id', 'integer');\n\n      this.addSystemColumn('Created Duration', 'createdDuration', '_created_duration', 'integer');\n      this.addSystemColumn('Updated Duration', 'updatedDuration', '_updated_duration', 'integer');\n      this.addSystemColumn('Edited Duration', 'editedDuration', '_edited_duration', 'integer');\n    }\n\n    this.setupElementColumns();\n  }\n\n  get tableName() {\n    return this.formSchema.tableName + '_' + this.repeatable.dataName;\n  }\n}\n"]}