{"version":3,"sources":["../../src/ast/converter.js"],"names":["columnRef","column","columnName","source","Converter","BooleanConverter","type","condition","options","args","nodeForExpressions","expressions","length","AndConverter","OrConverter","NotConverter","NotEmptyConverter","expression","EmptyConverter","EqualConverter","BinaryConverter","NotEqualConverter","GreaterThanConverter","GreaterThanOrEqualConverter","LessThanConverter","LessThanOrEqualConverter","BetweenConverter","value1","value2","isDateOperator","ConvertDateValue","GetDate","startOf","endOf","Between","NotBetweenConverter","NotBetween","InConverter","In","value","NotInConverter","values","map","ConstValue","v","kind","operator","scalarValue","FieldConverter","name","ConstantConverter","TextEqualConverter","TextNotEqualConverter","TextContainConverter","escapeLikePercent","TextNotContainConverter","TextStartsWithConverter","TextEndsWithConverter","TextMatchConverter","TextNotMatchConverter","ArrayAnyOfConverter","AnyOf","ArrayAllOfConverter","ArrayEqualConverter","a","b","SearchConverter","rhs","DynamicDateConverter","now","range","arrayValues","isInteger","isNumber","date","timeZone","tz","guess","Date","clone","toISOString","toAST","query","sort","pageSize","pageIndex","boundingBox","searchFilter","targetList","joins","joinColumnsWithSorting","o","join","fromClause","whereClause","sortClause","limitOffset","limitCount","toCountAST","joinColumns","toTileAST","form","id","toHistogramAST","bucketSize","withClause","histogramWithClause","seriesFunctionSublinkSelect","seriesFunctionArgs","seriesFunctionCall","seriesFunction","bucketWidthFunctionCallArgs","bucketsSubqueryTargetList","bucketsSubqueryFromClause","bucketsSubqueryGroupClause","bucketsSubquerySortClause","bucketsSubquery","groupClause","bucketsSubselect","joinExpr","toDistinctValuesAST","isArray","push","by","recordsTargetList","datePartArgs","recordsFromClause","recordsSelect","recordsExpr","statsTargetList","statsFromClause","statsSelect","statsExpr","list","subJoinColumns","indexOf","schema","createdByColumn","updatedByColumn","assignedToColumn","projectColumn","leftJoins","baseQuery","visitedTables","alias","leftJoinClause","tableName","sourceColumn","joinColumn","search","systemParts","filterNode","nodeForCondition","filter","boundingBoxFilter","trim","nodeForExpression","dateFilter","createExpressionForColumnFilter","statusFilter","projectFilter","assignmentFilter","columnSettings","columns","item","hasFilter","isValid","table","tableColumn","except","hasValues","hasNull","forEach","isEmptySet","replace","toTsQuery","dictionary","term","makeTsQueryCall","toLowerCase","terms","split","s","shift","tsQueries","ftsExpression","ilikeExpression","andArgs","e","converter","And","Or","Not","Empty","NotEmpty","Equal","NotEqual","GreaterThan","GreaterThanOrEqual","LessThan","LessThanOrEqual","NotIn","TextContain","TextNotContain","TextStartsWith","TextEndsWith","TextEqual","TextNotEqual","TextMatch","TextNotMatch","DateEqual","DateNotEqual","DateAfter","DateOnOrAfter","DateBefore","DateOnOrBefore","DateBetween","DateNotBetween","ArrayAnyOf","ArrayAllOf","ArrayEqual","Search","DateToday","DateYesterday","DateTomorrow","DateLast7Days","DateLast30Days","DateLast90Days","DateLastMonth","DateLastYear","DateNextWeek","DateNextMonth","DateNextYear","DateCurrentCalendarWeek","DateCurrentCalendarMonth","DateCurrentCalendarYear","DatePreviousCalendarWeek","DatePreviousCalendarMonth","DatePreviousCalendarYear","DateNextCalendarWeek","DateNextCalendarMonth","DateNextCalendarYear","DateDaysFromNow","DateWeeksFromNow","DateMonthsFromNow","DateYearsFromNow","DateDaysAgo","DateWeeksAgo","DateMonthsAgo","DateYearsAgo"],"mappings":"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","file":"converter.js","sourcesContent":["import { ColumnRef,\n         ResTarget,\n         AStar,\n         RangeVar,\n         SelectStmt,\n         BoolExpr,\n         NullTest,\n         AExpr,\n         AConst,\n         StringValue,\n         AArrayExpr,\n         IntegerValue,\n         FloatValue,\n         SortBy,\n         TypeCast,\n         TypeName,\n         FuncCall,\n         WindowDef,\n         RangeSubselect,\n         WithClause,\n         CommonTableExpr,\n         RangeFunction,\n         JoinExpr,\n         Alias,\n         CoalesceExpr,\n         SubLink } from './helpers';\n\nimport { ConditionType } from '../condition';\nimport { OperatorType, calculateDateRange } from '../operator';\nimport moment from 'moment-timezone';\n\nconst columnRef = (column) => {\n  return ColumnRef(column.columnName, column.source);\n};\n\nexport default class Converter {\n  toAST(query, {sort, pageSize, pageIndex, boundingBox, searchFilter}) {\n    const targetList = this.targetList(query, sort);\n\n    const joins = query.joinColumnsWithSorting.map(o => o.join);\n\n    const fromClause = this.fromClause(query, joins);\n\n    const whereClause = this.whereClause(query, boundingBox, searchFilter);\n\n    const sortClause = sort;\n\n    const limitOffset = this.limitOffset(pageSize, pageIndex);\n\n    const limitCount = this.limitCount(pageSize);\n\n    return SelectStmt({targetList, fromClause, whereClause, sortClause, limitOffset, limitCount});\n  }\n\n  toCountAST(query, {boundingBox, searchFilter}) {\n    const targetList = [ ResTarget(FuncCall('count', [ AConst(IntegerValue(1)) ]), 'total_count') ];\n\n    const joins = query.joinColumns.map(o => o.join);\n\n    const fromClause = this.fromClause(query, joins);\n\n    const whereClause = this.whereClause(query, boundingBox, searchFilter);\n\n    return SelectStmt({targetList, fromClause, whereClause});\n  }\n\n  toTileAST(query, {searchFilter}) {\n    const targetList = [\n      ResTarget(ColumnRef('_record_id')),\n      ResTarget(FuncCall('st_x', [ ColumnRef('_geometry') ]), 'x'),\n      ResTarget(FuncCall('st_y', [ ColumnRef('_geometry') ]), 'y'),\n      ResTarget(ColumnRef('_status')),\n      ResTarget(TypeCast(TypeName('text'), AConst(StringValue(query.form.id))), 'form_id')\n    ];\n\n    const fromClause = this.fromClause(query);\n\n    const whereClause = this.whereClause(query, null, searchFilter);\n\n    return SelectStmt({targetList, fromClause, whereClause});\n  }\n\n  toHistogramAST(query, {columnName, bucketSize, type, sort, pageSize, pageIndex, boundingBox, searchFilter}) {\n    const targetList = [\n      ResTarget(ColumnRef('series', 'series'), 'bucket'),\n      ResTarget(CoalesceExpr([ ColumnRef('count', 'sub'), AConst(IntegerValue(0)) ]), 'count'),\n      ResTarget(ColumnRef('min_value', 'sub'), 'min_value'),\n      ResTarget(ColumnRef('max_value', 'sub'), 'max_value'),\n      ResTarget(ColumnRef('avg_value', 'sub'), 'avg_value'),\n      ResTarget(ColumnRef('sum_value', 'sub'), 'sum_value')\n    ];\n\n    const withClause = this.histogramWithClause(columnName, bucketSize, type, query);\n\n    const seriesFunctionSublinkSelect = SelectStmt({\n      targetList: [ ResTarget(AExpr(0, '+', ColumnRef('buckets'), AConst(IntegerValue(1)))) ],\n      fromClause: [ RangeVar('__stats') ]\n    });\n\n    const seriesFunctionArgs = [\n      AConst(IntegerValue(1)),\n      SubLink(4, seriesFunctionSublinkSelect)\n    ];\n\n    const seriesFunctionCall = FuncCall('generate_series', seriesFunctionArgs);\n    const seriesFunction = RangeFunction([ [ seriesFunctionCall ] ], Alias('series'));\n\n    const bucketWidthFunctionCallArgs = [\n      TypeCast(TypeName([ StringValue('pg_catalog'), StringValue('float8') ]), ColumnRef('value')),\n      SubLink(4, SelectStmt({targetList: [ ResTarget(ColumnRef('min_value')) ], fromClause: [ RangeVar('__stats') ]})),\n      SubLink(4, SelectStmt({targetList: [ ResTarget(ColumnRef('max_value')) ], fromClause: [ RangeVar('__stats') ]})),\n      SubLink(4, SelectStmt({targetList: [ ResTarget(ColumnRef('buckets')) ], fromClause: [ RangeVar('__stats') ]}))\n    ];\n\n    const bucketsSubqueryTargetList = [\n      ResTarget(FuncCall('width_bucket', bucketWidthFunctionCallArgs), 'bucket'),\n      ResTarget(FuncCall('count', [ AConst(IntegerValue(1)) ]), 'count'),\n      ResTarget(FuncCall('min', [ ColumnRef('value') ]), 'min_value'),\n      ResTarget(FuncCall('max', [ ColumnRef('value') ]), 'max_value'),\n      ResTarget(FuncCall('avg', [ ColumnRef('value') ]), 'avg_value'),\n      ResTarget(FuncCall('sum', [ ColumnRef('value') ]), 'sum_value')\n    ];\n\n    const bucketsSubqueryFromClause = [ RangeVar('__records') ];\n    const bucketsSubqueryGroupClause = [ AConst(IntegerValue(1)) ];\n    const bucketsSubquerySortClause = [ SortBy(AConst(IntegerValue(1)), 0, 0) ];\n\n    const bucketsSubquery = SelectStmt({\n      targetList: bucketsSubqueryTargetList,\n      fromClause: bucketsSubqueryFromClause,\n      groupClause: bucketsSubqueryGroupClause,\n      sortClause: bucketsSubquerySortClause\n    });\n\n    const bucketsSubselect = RangeSubselect(bucketsSubquery, Alias('sub'));\n\n    const joinExpr = JoinExpr(1,\n                              seriesFunction,\n                              bucketsSubselect,\n                              AExpr(0, '=', ColumnRef('series', 'series'), ColumnRef('bucket', 'sub')));\n\n    return SelectStmt({targetList, fromClause: [ joinExpr ], withClause});\n  }\n\n  toDistinctValuesAST(query, options = {}) {\n    const targetList = options.column.isArray ? [ ResTarget(FuncCall('unnest', [ columnRef(options.column) ]), 'value') ]\n                                              : [ ResTarget(columnRef(options.column), 'value') ];\n\n    targetList.push(ResTarget(FuncCall('count', [ AConst(IntegerValue(1)) ]), 'count'));\n\n    const joins = options.column.join ? [ options.column.join ] : null;\n\n    const fromClause = this.fromClause(query, joins);\n\n    // const whereClause = null; // options.all ? null : this.whereClause(query);\n    // TODO(zhm) need to pass the bbox and search here?\n    const whereClause = this.whereClause(query, null, null, options);\n\n    const groupClause = [ AConst(IntegerValue(1)) ];\n\n    const sortClause = [];\n\n    if (options.by === 'frequency') {\n      sortClause.push(SortBy(AConst(IntegerValue(2)), 2, 0));\n    }\n\n    sortClause.push(SortBy(AConst(IntegerValue(1)), 1, 0));\n\n    return SelectStmt({targetList, fromClause, whereClause, groupClause, sortClause});\n  }\n\n  histogramWithClause(columnName, bucketSize, type, query) {\n    let recordsTargetList = null;\n\n    if (type === 'date') {\n      const datePartArgs = [\n        AConst(StringValue('epoch')),\n        TypeCast(TypeName('date'), ColumnRef(columnName))\n      ];\n\n      recordsTargetList = [ ResTarget(FuncCall('date_part', datePartArgs), 'value') ];\n    } else {\n      recordsTargetList = [ ResTarget(TypeCast(TypeName([ StringValue('pg_catalog'), StringValue('float8') ]), ColumnRef(columnName)), 'value') ];\n    }\n\n    const recordsFromClause = [ RangeVar(query.form.id + '/_full') ];\n    const recordsSelect = SelectStmt({targetList: recordsTargetList, fromClause: recordsFromClause});\n    const recordsExpr = CommonTableExpr('__records', recordsSelect);\n\n    const statsTargetList = [\n      ResTarget(AConst(IntegerValue(bucketSize)), 'buckets'),\n      ResTarget(FuncCall('count', [ AConst(IntegerValue(1)) ]), 'count'),\n      ResTarget(FuncCall('min', [ ColumnRef('value') ]), 'min_value'),\n      ResTarget(FuncCall('max', [ ColumnRef('value') ]), 'max_value')\n    ];\n\n    const statsFromClause = [ RangeVar('__records') ];\n    const statsSelect = SelectStmt({targetList: statsTargetList, fromClause: statsFromClause});\n    const statsExpr = CommonTableExpr('__stats', statsSelect);\n\n    return WithClause([ recordsExpr, statsExpr ]);\n  }\n\n  limitOffset(pageSize, pageIndex) {\n    if (pageSize != null && pageIndex != null) {\n      return AConst(IntegerValue(+pageIndex * +pageSize));\n    }\n\n    return null;\n  }\n\n  limitCount(pageSize) {\n    if (pageSize != null) {\n      return AConst(IntegerValue(+pageSize));\n    }\n\n    return null;\n  }\n\n  targetList(query, sort) {\n    const list = [\n      ResTarget(ColumnRef(AStar()))\n    ];\n\n    const subJoinColumns = query.joinColumnsWithSorting;\n\n    if (subJoinColumns.indexOf(query.schema.createdByColumn) !== -1) {\n      list.push(ResTarget(ColumnRef('name', 'created_by'), 'created_by.name'));\n    }\n\n    if (subJoinColumns.indexOf(query.schema.updatedByColumn) !== -1) {\n      list.push(ResTarget(ColumnRef('name', 'updated_by'), 'updated_by.name'));\n    }\n\n    if (subJoinColumns.indexOf(query.schema.assignedToColumn) !== -1) {\n      list.push(ResTarget(ColumnRef('name', 'assigned_to'), 'assigned_to.name'));\n    }\n\n    if (subJoinColumns.indexOf(query.schema.projectColumn) !== -1) {\n      list.push(ResTarget(ColumnRef('name', 'project'), 'project.name'));\n    }\n\n    list.push(ResTarget(FuncCall('row_number', null, WindowDef(sort, 530)), '_row_number'));\n\n    return list;\n  }\n\n  fromClause(query, leftJoins = []) {\n    let baseQuery = RangeVar(query.form.id + '/_full', Alias('records'));\n\n    const visitedTables = {};\n\n    if (leftJoins) {\n      for (const join of leftJoins) {\n        if (!visitedTables[join.alias]) {\n          visitedTables[join.alias] = join;\n\n          baseQuery = Converter.leftJoinClause(baseQuery, join.tableName, join.alias, join.sourceColumn, join.joinColumn);\n        }\n      }\n    }\n\n    return [ baseQuery ];\n  }\n\n  whereClause(query, boundingBox, search, options = {}) {\n    const systemParts = [];\n    options = {...query.options || {}, ...options};\n\n    const filterNode = this.nodeForCondition(query.filter, options);\n\n    if (boundingBox) {\n      systemParts.push(this.boundingBoxFilter(boundingBox));\n    }\n\n    if (search && search.trim().length) {\n      systemParts.push(this.searchFilter(search));\n    }\n\n    systemParts.push(this.nodeForExpression(query.dateFilter, options));\n    systemParts.push(this.createExpressionForColumnFilter(query.statusFilter, options));\n    systemParts.push(this.createExpressionForColumnFilter(query.projectFilter, options));\n    systemParts.push(this.createExpressionForColumnFilter(query.assignmentFilter, options));\n\n    for (const item of query.columnSettings.columns) {\n      if (item.hasFilter) {\n        const expression = this.createExpressionForColumnFilter(item.filter, options);\n\n        if (expression) {\n          systemParts.push(expression);\n        }\n      }\n\n      if (item.search) {\n        systemParts.push(AExpr(8, '~~*', columnRef(item.column),\n                                         AConst(StringValue('%' + this.escapeLikePercent(item.search) + '%'))));\n      }\n\n      if (item.expression.isValid) {\n        systemParts.push(this.nodeForExpression(item.expression, options));\n      }\n\n      if (item.range.isValid) {\n        systemParts.push(this.nodeForExpression(item.range, options));\n      }\n    }\n\n    const expressions = systemParts.filter(o => o != null);\n\n    if (filterNode && expressions.length) {\n      return BoolExpr(0, [ filterNode, ...expressions ]);\n    } else if (expressions.length) {\n      return BoolExpr(0, [ ...expressions ]);\n    }\n\n    return filterNode;\n  }\n\n  static leftJoinClause(baseQuery, table, alias, sourceColumn, tableColumn) {\n    return JoinExpr(1,\n                    baseQuery,\n                    RangeVar(table, Alias(alias)),\n                    AExpr(0, '=', ColumnRef(sourceColumn, 'records'), ColumnRef(tableColumn, alias)));\n  }\n\n  createExpressionForColumnFilter(filter, options) {\n    let expression = null;\n\n    if (filter === options.except) {\n      return null;\n    }\n\n    if (filter.hasValues) {\n      let hasNull = false;\n      const values = [];\n\n      filter.value.forEach(v => {\n        if (v != null) {\n          values.push(v);\n        } else {\n          hasNull = true;\n        }\n      });\n\n      if (values.length) {\n        if (filter.column.isArray) {\n          expression = this.AnyOf(filter.column, values);\n        } else {\n          expression = this.In(filter.column, values);\n        }\n\n        if (hasNull) {\n          expression = BoolExpr(1, [ NullTest(0, columnRef(filter.column)), expression ]);\n        }\n      } else if (hasNull) {\n        expression = NullTest(0, columnRef(filter.column));\n      }\n    } else if (filter.isEmptySet) {\n      // add 1 = 0 clause to return 0 rows\n      expression = AExpr(0, '=', AConst(IntegerValue(1)),\n                                 AConst(IntegerValue(0)));\n    }\n\n    return expression;\n  }\n\n  boundingBoxFilter(boundingBox) {\n    const args = [\n      AConst(FloatValue(boundingBox[0])),\n      AConst(FloatValue(boundingBox[1])),\n      AConst(FloatValue(boundingBox[2])),\n      AConst(FloatValue(boundingBox[3])),\n      AConst(IntegerValue(4326))\n    ];\n\n    const rhs = FuncCall('st_makeenvelope', args);\n\n    return AExpr(0, '&&', ColumnRef('_geometry'), rhs);\n  }\n\n  escapeLikePercent(value) {\n    return value.replace(/\\%/g, '\\\\%');\n  }\n\n  searchFilter(search) {\n    /*\n       Search takes the general form:\n\n       SELECT ...\n       FROM ...\n       WHERE\n         _record_index @@ to_tsquery('english', '''bacon'':*'::tsquery::text) AND\n         _record_index_text ILIKE '%bacon%'\n\n       NB: The awkward cast through a text type is to properly escape raw user input as a tsquery.\n\n       For example:\n         to_tsquery('Nor:*') vs 'Nor:*'::tsquery\n\n       Also, the ILIKE handles further reduces the resultset to exact matches which is what Fulcrum\n       users more often expect. The general idea is to use the FTS index to massively reduce the result\n       set before applying the much slower ILIKE operation. So, we can reduce the result very quickly\n       with the tsvector index first, and then only run the ILIKE on what's left.\n    */\n\n    search = search.trim();\n\n    const toTsQuery = (dictionary, term) => {\n      const args = [ AConst(StringValue(dictionary)), AConst(StringValue(\"'\" + term + \"':*\")) ];\n\n      return FuncCall('to_tsquery', args);\n    };\n\n    const makeTsQueryCall = (term) => {\n      return toTsQuery(term.length > 3 ? 'english' : 'simple',\n                       term.toLowerCase().replace(/'/g, \"''\"));\n    };\n\n    const terms = search.split(' ').filter(s => s.trim().length);\n\n    let term = terms.shift();\n\n    let tsQueries = makeTsQueryCall(term);\n\n    while (terms.length) {\n      term = terms.shift();\n      tsQueries = AExpr(0, '&&', tsQueries, makeTsQueryCall(term));\n    }\n\n    const ftsExpression = AExpr(0, '@@', ColumnRef('_record_index'), tsQueries);\n\n    const ilikeExpression = AExpr(8, '~~*', ColumnRef('_record_index_text'),\n                                  AConst(StringValue('%' + this.escapeLikePercent(search) + '%')));\n\n    const andArgs = [\n      ftsExpression,\n      ilikeExpression\n    ];\n\n    return BoolExpr(0, andArgs);\n  }\n\n  nodeForExpressions(expressions, options) {\n    return expressions.map(e => this.nodeForExpression(e, options))\n                      .filter(e => e);\n  }\n\n  nodeForCondition(condition, options) {\n    const converter = {\n      [ConditionType.And]: this.AndConverter,\n      [ConditionType.Or]: this.OrConverter,\n      [ConditionType.Not]: this.NotConverter\n    };\n\n    return converter[condition.type](condition, options);\n  }\n\n  nodeForExpression(expression, options) {\n    if (expression.expressions) {\n      return this.nodeForCondition(expression, options);\n    }\n\n    if (expression === options.except) {\n      return null;\n    }\n\n    const converter = {\n      [OperatorType.Empty.name]: this.EmptyConverter,\n      [OperatorType.NotEmpty.name]: this.NotEmptyConverter,\n      [OperatorType.Equal.name]: this.EqualConverter,\n      [OperatorType.NotEqual.name]: this.NotEqualConverter,\n      [OperatorType.GreaterThan.name]: this.GreaterThanConverter,\n      [OperatorType.GreaterThanOrEqual.name]: this.GreaterThanOrEqualConverter,\n      [OperatorType.LessThan.name]: this.LessThanConverter,\n      [OperatorType.LessThanOrEqual.name]: this.LessThanOrEqualConverter,\n      [OperatorType.Between.name]: this.BetweenConverter,\n      [OperatorType.NotBetween.name]: this.NotBetweenConverter,\n      [OperatorType.In.name]: this.InConverter,\n      [OperatorType.NotIn.name]: this.NotInConverter,\n      [OperatorType.TextContain.name]: this.TextContainConverter,\n      [OperatorType.TextNotContain.name]: this.TextNotContainConverter,\n      [OperatorType.TextStartsWith.name]: this.TextStartsWithConverter,\n      [OperatorType.TextEndsWith.name]: this.TextEndsWithConverter,\n      [OperatorType.TextEqual.name]: this.TextEqualConverter,\n      [OperatorType.TextNotEqual.name]: this.TextNotEqualConverter,\n      [OperatorType.TextMatch.name]: this.TextMatchConverter,\n      [OperatorType.TextNotMatch.name]: this.TextNotMatchConverter,\n      [OperatorType.DateEqual.name]: this.EqualConverter,\n      [OperatorType.DateNotEqual.name]: this.NotEqualConverter,\n      [OperatorType.DateAfter.name]: this.GreaterThanConverter,\n      [OperatorType.DateOnOrAfter.name]: this.GreaterThanOrEqualConverter,\n      [OperatorType.DateBefore.name]: this.LessThanConverter,\n      [OperatorType.DateOnOrBefore.name]: this.LessThanOrEqualConverter,\n      [OperatorType.DateBetween.name]: this.BetweenConverter,\n      [OperatorType.DateNotBetween.name]: this.NotBetweenConverter,\n      [OperatorType.ArrayAnyOf.name]: this.ArrayAnyOfConverter,\n      [OperatorType.ArrayAllOf.name]: this.ArrayAllOfConverter,\n      [OperatorType.ArrayEqual.name]: this.ArrayEqualConverter,\n      [OperatorType.Search.name]: this.SearchConverter,\n      [OperatorType.DateToday.name]: this.DynamicDateConverter,\n      [OperatorType.DateYesterday.name]: this.DynamicDateConverter,\n      [OperatorType.DateTomorrow.name]: this.DynamicDateConverter,\n      [OperatorType.DateLast7Days.name]: this.DynamicDateConverter,\n      [OperatorType.DateLast30Days.name]: this.DynamicDateConverter,\n      [OperatorType.DateLast90Days.name]: this.DynamicDateConverter,\n      [OperatorType.DateLastMonth.name]: this.DynamicDateConverter,\n      [OperatorType.DateLastYear.name]: this.DynamicDateConverter,\n      [OperatorType.DateNextWeek.name]: this.DynamicDateConverter,\n      [OperatorType.DateNextMonth.name]: this.DynamicDateConverter,\n      [OperatorType.DateNextYear.name]: this.DynamicDateConverter,\n      [OperatorType.DateCurrentCalendarWeek.name]: this.DynamicDateConverter,\n      [OperatorType.DateCurrentCalendarMonth.name]: this.DynamicDateConverter,\n      [OperatorType.DateCurrentCalendarYear.name]: this.DynamicDateConverter,\n      [OperatorType.DatePreviousCalendarWeek.name]: this.DynamicDateConverter,\n      [OperatorType.DatePreviousCalendarMonth.name]: this.DynamicDateConverter,\n      [OperatorType.DatePreviousCalendarYear.name]: this.DynamicDateConverter,\n      [OperatorType.DateNextCalendarWeek.name]: this.DynamicDateConverter,\n      [OperatorType.DateNextCalendarMonth.name]: this.DynamicDateConverter,\n      [OperatorType.DateNextCalendarYear.name]: this.DynamicDateConverter,\n      [OperatorType.DateDaysFromNow.name]: this.DynamicDateConverter,\n      [OperatorType.DateWeeksFromNow.name]: this.DynamicDateConverter,\n      [OperatorType.DateMonthsFromNow.name]: this.DynamicDateConverter,\n      [OperatorType.DateYearsFromNow.name]: this.DynamicDateConverter,\n      [OperatorType.DateDaysAgo.name]: this.DynamicDateConverter,\n      [OperatorType.DateWeeksAgo.name]: this.DynamicDateConverter,\n      [OperatorType.DateMonthsAgo.name]: this.DynamicDateConverter,\n      [OperatorType.DateYearsAgo.name]: this.DynamicDateConverter\n    };\n\n    if (!expression.isValid) {\n      return null;\n    }\n\n    return converter[expression.operator](expression, options);\n  }\n\n  BooleanConverter = (type, condition, options) => {\n    const args = this.nodeForExpressions(condition.expressions, options);\n\n    if (args && args.length) {\n      return BoolExpr(type, args);\n    }\n\n    return null;\n  }\n\n  AndConverter = (condition, options) => {\n    return this.BooleanConverter(0, condition, options);\n  }\n\n  OrConverter = (condition, options) => {\n    return this.BooleanConverter(1, condition, options);\n  }\n\n  NotConverter = (condition, options) => {\n    if (condition.expressions.length > 1) {\n      return BoolExpr(2, [ this.BooleanConverter(0, condition, options) ]);\n    }\n\n    return this.BooleanConverter(2, condition, options);\n  }\n\n  NotEmptyConverter = (expression) => {\n    return NullTest(1, columnRef(expression.column));\n  }\n\n  EmptyConverter = (expression) => {\n    return NullTest(0, columnRef(expression.column));\n  }\n\n  EqualConverter = (expression) => {\n    return this.BinaryConverter(0, '=', expression);\n  }\n\n  NotEqualConverter = (expression) => {\n    return this.BinaryConverter(0, '<>', expression);\n  }\n\n  GreaterThanConverter = (expression) => {\n    return this.BinaryConverter(0, '>', expression);\n  }\n\n  GreaterThanOrEqualConverter = (expression) => {\n    return this.BinaryConverter(0, '>=', expression);\n  }\n\n  LessThanConverter = (expression) => {\n    return this.BinaryConverter(0, '<', expression);\n  }\n\n  LessThanOrEqualConverter = (expression) => {\n    return this.BinaryConverter(0, '<=', expression);\n  }\n\n  BetweenConverter = (expression, options) => {\n    let value1 = expression.value1;\n    let value2 = expression.value2;\n\n    if (expression.isDateOperator) {\n      value1 = value1 && this.ConvertDateValue(this.GetDate(value1, options).startOf('day'));\n      value2 = value2 && this.ConvertDateValue(this.GetDate(value2, options).endOf('day'));\n    }\n\n    return this.Between(expression.column, value1, value2);\n  }\n\n  NotBetweenConverter = (expression, options) => {\n    let value1 = expression.value1;\n    let value2 = expression.value2;\n\n    if (expression.isDateOperator) {\n      value1 = value1 && this.ConvertDateValue(this.GetDate(value1, options).startOf('day'));\n      value2 = value2 && this.ConvertDateValue(this.GetDate(value2, options).endOf('day'));\n    }\n\n    return this.NotBetween(expression.column, value1, value2);\n  }\n\n  InConverter = (expression) => {\n    return this.In(expression.column, expression.value);\n  }\n\n  NotInConverter = (expression) => {\n    const values = expression.value.map(v => this.ConstValue(expression.column, v));\n\n    return AExpr(6, '<>', columnRef(expression.column),\n                 values);\n  }\n\n  BinaryConverter = (kind, operator, expression) => {\n    return AExpr(kind, operator, columnRef(expression.column),\n                 this.ConstValue(expression.column, expression.scalarValue));\n  }\n\n  FieldConverter = (expression) => {\n    return ColumnRef(expression.name);\n  }\n\n  ConstantConverter = (expression) => {\n    return this.ConstValue(expression.column, expression.scalarValue);\n  }\n\n  TextEqualConverter = (expression) => {\n    return AExpr(8, '~~*', columnRef(expression.column),\n                 this.ConstValue(expression.column, expression.scalarValue));\n  }\n\n  TextNotEqualConverter = (expression) => {\n    return AExpr(8, '!~~*', columnRef(expression.column),\n                 this.ConstValue(expression.column, expression.scalarValue));\n  }\n\n  TextContainConverter = (expression) => {\n    return AExpr(8, '~~*', columnRef(expression.column),\n                 AConst(StringValue('%' + this.escapeLikePercent(expression.scalarValue) + '%')));\n  }\n\n  TextNotContainConverter = (expression) => {\n    return AExpr(8, '!~~*', columnRef(expression.column),\n                 AConst(StringValue('%' + this.escapeLikePercent(expression.scalarValue) + '%')));\n  }\n\n  TextStartsWithConverter = (expression) => {\n    return AExpr(8, '~~*', columnRef(expression.column),\n                 AConst(StringValue(this.escapeLikePercent(expression.scalarValue) + '%')));\n  }\n\n  TextEndsWithConverter = (expression) => {\n    return AExpr(8, '~~*', columnRef(expression.column),\n                 AConst(StringValue('%' + this.escapeLikePercent(expression.scalarValue))));\n  }\n\n  TextMatchConverter = (expression) => {\n    return AExpr(0, '~*', columnRef(expression.column),\n                 AConst(StringValue(expression.scalarValue)));\n  }\n\n  TextNotMatchConverter = (expression) => {\n    return AExpr(0, '!~*', columnRef(expression.column),\n                 AConst(StringValue(expression.scalarValue)));\n  }\n\n  ArrayAnyOfConverter = (expression) => {\n    return this.AnyOf(expression.column, expression.value);\n  }\n\n  ArrayAllOfConverter = (expression) => {\n    const values = AArrayExpr(expression.value.map(v => this.ConstValue(expression.column, v)));\n\n    return AExpr(0, '@>', columnRef(expression.column),\n                 values);\n  }\n\n  ArrayEqualConverter = (expression) => {\n    const values = AArrayExpr(expression.value.map(v => this.ConstValue(expression.column, v)));\n\n    const a = AExpr(0, '<@', columnRef(expression.column),\n                    values);\n\n    const b = AExpr(0, '@>', columnRef(expression.column),\n                    values);\n\n    return BoolExpr(0, [ a, b ]);\n  }\n\n  SearchConverter = (expression) => {\n    const rhs = FuncCall('to_tsquery', [ this.ConstValue(expression.column, expression.scalarValue) ]);\n\n    return AExpr(0, '@@', columnRef(expression.column),\n                 rhs);\n  }\n\n  DynamicDateConverter = (expression, options) => {\n    // Let the caller specify the timezone to be used for dynamic date calculations. This\n    // makes sure when the browser calculates a dynamic range, the server would calculate\n    // the same range. So 'Today' is midnight to midnight in the user's local time. It would\n    // be much less useful and confusing if we forced \"Today\" to always be London's today.\n    const now = this.GetDate(null, options);\n\n    const range = calculateDateRange(expression.operator, expression.value, now);\n\n    const value1 = this.ConvertDateValue(range[0]);\n    const value2 = this.ConvertDateValue(range[1]);\n\n    return this.Between(expression.column, value1, value2);\n  }\n\n  NotBetween = (column, value1, value2) => {\n    if (value1 != null && value2 != null) {\n      return AExpr(11, 'NOT BETWEEN', columnRef(column), [ this.ConstValue(column, value1), this.ConstValue(column, value2) ]);\n    } else if (value1 != null) {\n      return AExpr(0, '<', columnRef(column), this.ConstValue(column, value1));\n    } else if (value2 != null) {\n      return AExpr(0, '>', columnRef(column), this.ConstValue(column, value2));\n    }\n\n    return null;\n  }\n\n  AnyOf = (column, values) => {\n    const arrayValues = AArrayExpr(values.map(v => this.ConstValue(column, v)));\n\n    return AExpr(0, '&&', columnRef(column), arrayValues);\n  }\n\n  In = (column, values) => {\n    const arrayValues = values.map(v => this.ConstValue(column, v));\n\n    return AExpr(6, '=', columnRef(column), arrayValues);\n  }\n\n  Between = (column, value1, value2) => {\n    if (value1 != null && value2 != null) {\n      return AExpr(10, 'BETWEEN', columnRef(column), [ this.ConstValue(column, value1), this.ConstValue(column, value2) ]);\n    } else if (value1 != null) {\n      return AExpr(0, '>=', columnRef(column), this.ConstValue(column, value1));\n    } else if (value2 != null) {\n      return AExpr(0, '<=', columnRef(column), this.ConstValue(column, value2));\n    }\n\n    return null;\n  }\n\n  ConstValue = (column, value) => {\n    if (value == null) {\n      return null;\n    }\n\n    if (column.isInteger) {\n      return AConst(IntegerValue(value));\n    }\n\n    if (column.isNumber) {\n      return AConst(FloatValue(value));\n    }\n\n    return AConst(StringValue(value));\n  }\n\n  GetDate = (date, options) => {\n    const timeZone = (options && options.timeZone) || moment.tz.guess();\n\n    return moment(date || new Date()).tz(timeZone);\n  }\n\n  ConvertDateValue = (date) => {\n    if (date) {\n      return date.clone().toISOString();\n    }\n    return null;\n  }\n}\n"]}